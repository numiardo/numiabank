<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NumiaBank - Innova tu banca</title>
  <!-- FAVICON para la pestaña -->
  <link rel="icon" type="image/png" href="images/N.png" />
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
  <!-- Google Font Roboto -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet"/>
  <!-- Flatpickr -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

    .JB {
      position: fixed;
      bottom: 24px;
      right: 24px;
      z-index: 9999;
    }

    body {
      font-family: 'Inter', system-ui, sans-serif;
      background-color: #f9f9f9;
      color: #333;
      padding: 20px;
    }
    .boton-fecha {
      background-color: #863DFF;
      color: white;
      font-weight: 500;
      padding: 0.5rem 0.5rem;
      border-radius: 0.5rem;
      transition: background-color 0.2s ease;
      margin-top: 20px;
    }
    .boton-fecha:hover {
      background-color: #863DFF;
    }
    .input-field {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 2px solid #d1d5db;
      border-radius: 0.5rem;
      background-color: #ffffff;
      color: #333;
      transition: all 0.2s ease;
    }
    .input-field:focus {
      border-color: #863DFF;
      box-shadow: 0 0 0 2px rgba(237, 122, 26, 0.2);
      outline: none;
    }
    h2, .titulo {
      text-align: center;
      color: #863DFF;
      margin-top: 20px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    #formularioInicial, #resultados, #formularioDatos, #bloqueFecha {
      background-color: #ffffff;
      padding: 20px;
      border-radius: 0.75rem;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      margin-top: 20px;
    }
    #formularioInicial {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
    }
    #formularioTurno {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    /* Popup */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0; top: 0;
      width: 100%; height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.5);
    }
    .modal-content {
      background-color: #fff;
      margin: 5% auto;
      padding: 30px;
      border-radius: 8px;
      width: 90%;
      max-width: 800px;
      position: relative;
    }
    .close {
      position: absolute;
      right: 15px;
      top: 10px;
      font-size: 24px;
      font-weight: bold;
      cursor: pointer;
    }

    body { font-family: 'Inter', system-ui, sans-serif; }
    .btn-primary { /* Tailwind @apply placeholders (no-op en CSS puro) */ }
    .btn-secondary {}
    .card {}
    .input-field {}

    #formModal .input-field {}

    /* Botones popup */
    #formModal .btn-primary {
      background-color: #863DFF !important;
      color: white !important;
      font-weight: 500 !important;
      padding: 0.75rem 1.5rem !important;
      border-radius: 0.5rem !important;
      transition: background-color 0.2s ease !important;
    }
    #formModal .btn-primary:hover { background-color: #863DFF !important; }

    /* --- Variables de color --- */
    :root {
      --numia-azul: #863DFF;
      --numia-azul-claro: #e6ecf9;
      --numia-azul-muy-claro: #eef2fc;
    }

    body {
      font-family: 'Roboto', Arial, sans-serif;
      background: #f7f7f7;
    }
    .card.ad-card {
      border-radius: 1.2rem;
      box-shadow: 0 4px 18px rgba(0,0,0,0.08);
      transition: transform 0.18s, box-shadow 0.18s;
      min-width: 210px;
      min-height: 380px;
      display: flex;
      flex-direction: column;
      justify-content: stretch;
      height: 100%;
    }
    .card.ad-card:hover {
      transform: translateY(-4px) scale(1.025);
      box-shadow: 0 8px 32px rgba(0,19,145,0.17);
    }
    .card-img-top-holder {
      width: 100%;
      height: 180px;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      background: #fff8f8;
      border-top-left-radius: 1.2rem;
      border-top-right-radius: 1.2rem;
    }
    .card-img-top-holder img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      object-position: center;
      transition: transform 0.3s;
    }
    .ad-card .card-body {
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      height: 100%;
      padding-bottom: 1.5rem;
    }
    .ad-card .card-title {
      font-weight: 700;
      color: var(--numia-azul);
      font-size: 1.25rem;
      margin-bottom: .25rem;
      margin-top: 1rem;
      min-height: 3rem;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
    }
    .ad-card .card-text {
      font-size: 1.01rem;
      color: #2d2d2d;
      font-weight: 500;
      opacity: 0.88;
      margin-bottom: 1.1rem;
      min-height: 56px;
      text-align: center;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .carousel-item img {
      object-fit: cover;
      width: 100%;
      height: 340px;
      border-radius: 0.7rem;
    }
    @media (max-width: 991px) {
      .main-cards .col-lg-3 {
        flex: 0 0 50%;
        max-width: 50%;
        margin-bottom: 1rem;
      }
      .carousel-item img { height: 180px; }
    }
    @media (max-width: 767px) {
      .main-cards .col-lg-3 {
        flex: 0 0 100%;
        max-width: 100%;
      }
      .carousel-item img { height: 140px; }
      .card-img-top-holder { height: 140px; }
      .ad-card .card-title { font-size: 1.08rem; }
    }

    /* --- Sección de Divisas/Tasas --- */
    .rates-section {
      display: flex;
      gap: 2.2rem;
      align-items: stretch;
      margin: 36px 0 0 0;
      width: 100%;
      flex-wrap: wrap;
    }
    .rates-col-table {
      background: #fff;
      border-radius: 1.1rem;
      box-shadow: 0 2px 12px rgba(0,0,0,0.07);
      padding: 2.1rem 1.6rem 1.6rem 1.7rem;
      min-width: 340px;
      flex: 2 1 540px;
      max-width: 1000px;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
    }
    .rates-col-side {
      background: #fff;
      border-radius: 1.1rem;
      box-shadow: 0 2px 12px rgba(0,0,0,0.07);
      padding: 2.1rem 1.6rem 1.6rem 1.7rem;
      min-width: 220px;
      flex: 1 1 320px;
      max-width: 420px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: flex-start;
    }
    .rates-col-side .bi {
      font-size: 2.6rem;
      color: var(--numia-azul);
      margin-bottom: .7rem;
    }
    .rates-col-side h5 {
      color: var(--numia-azul);
      font-weight: 700;
      margin-bottom: .5rem;
      font-size: 1.2rem;
    }
    .rates-col-side p {
      color: #444;
      font-size: 1.07rem;
      font-weight: 500;
      margin-bottom: 1.2rem;
      opacity: .93;
    }
    .rates-col-side .btn {
      background: var(--numia-azul);
      border: none;
      color: #fff;
      font-weight: 700;
      border-radius: 24px;
      padding: 0.7rem 2.1rem;
      font-size: 1.07rem;
      box-shadow: 0 2px 7px rgba(0,19,145,0.06);
      transition: background 0.18s;
    }
    .rates-col-side .btn:hover {
      background: #000d73;
      color: #fff;
    }

    .rates-tab-btn {
      padding: .7rem 0;
      border: none;
      border-radius: 9px;
      font-weight: bold;
      font-size: 1.1rem;
      background: #fff;
      color: var(--numia-azul);
      margin-bottom: 0;
      transition: background .16s, color .16s;
      cursor: pointer;
      box-shadow: none;
      outline: none;
      border: 2px solid #d1d9f9;
      min-width: 70px;
    }
    .rates-tab-btn.active,
    .rates-tab-btn:focus {
      background: var(--numia-azul);
      color: #fff;
      border: 2px solid var(--numia-azul);
    }

    .rates-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      background: #fff;
      border-radius: 0.8rem;
      overflow: hidden;
      margin-top: 0.7rem;
    }
    .rates-table th,
    .rates-table td {
      padding: 12px 18px;
      font-size: 1.04rem;
      text-align: left;
    }
    .rates-table th {
      color: var(--numia-azul);
      background: var(--numia-azul-claro);
      border: none;
      font-size: 1.08rem;
      font-weight: 700;
      text-align: center;
      letter-spacing: 0.02em;
    }
    .rates-table tr:not(:last-child) { border-bottom: 1px solid #cde0f8; }
    .rates-table tr:nth-child(2) { background: var(--numia-azul-claro); }
    .rates-table tr:nth-child(3) { background: var(--numia-azul-muy-claro); }
    .rates-table td {
      color: #222;
      font-weight: 500;
      text-align: center;
      vertical-align: middle;
    }
    .rates-table td:first-child,
    .rates-table th:first-child { text-align: left; }

    @media (max-width: 1300px) {
      .rates-col-table { min-width: 0; flex-basis: 400px; }
      .rates-col-side { min-width: 0; }
    }
    @media (max-width: 991px) {
      .rates-section { flex-direction: column; gap: 1.4rem; }
      .rates-col-table, .rates-col-side { min-width: 0; max-width: 100%; }
      .rates-col-side { align-items: flex-start; padding-top: 1.2rem; }
    }

    .btn-primary {
      background-color: var(--numia-azul) !important;
      border-color: var(--numia-azul) !important;
    }
    .btn-primary:hover {
      background-color: #000d73 !important;
      border-color: #000d73 !important;
    }
    .btn-outline-primary {
      color: var(--numia-azul) !important;
      border-color: var(--numia-azul) !important;
    }
    .btn-outline-primary:hover {
      background-color: var(--numia-azul) !important;
      color: #fff !important;
    }

    #max-chat { background: var(--numia-azul) !important; }
    #open-chat { background: var(--numia-azul) !important; }
  </style>
</head>
<body class="d-flex flex-column min-vh-100">

  <!-- Encabezado con logos -->
  <header class="bg-white shadow-sm py-2 mb-0">
    <div class="container">
      <div class="d-flex justify-content-between align-items-right">
        <a href="index.html" class="d-block">
          <img src="images/numia.png" alt="Numia Bank Logo" class="img-fluid" style="max-height: 88px;" />
        </a>
      </div>
      <p class="lead mt-2 mb-0 text-dark text-start" style="font-size:1rem;">
        Innovación en tus finanzas, potenciada por IA manteniendo el toque humano
      </p>
    </div>
  </header>

  <!-- NAVBAR -->
  <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm border-bottom" style="z-index:1050;">
    <div class="container">
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarMain" aria-controls="navbarMain" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse justify-content-center" id="navbarMain">
        <ul class="navbar-nav mb-2 mb-lg-0">
          <li class="nav-item dropdown px-2">
            <a class="nav-link dropdown-toggle fw-semibold" href="#" id="cuentasDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
              <i class="bi bi-wallet2 me-1"></i>Cuentas
            </a>
            <ul class="dropdown-menu" aria-labelledby="cuentasDropdown">
              <li><a class="dropdown-item" href="#"><i class="bi bi-phone me-2"></i>Cuenta Digital</a></li>
              <li><a class="dropdown-item" href="#"><i class="bi bi-cash-coin me-2"></i>Cuenta Nómina</a></li>
              <li><a class="dropdown-item" href="#"><i class="bi bi-emoji-smile me-2"></i>Cuenta Kids</a></li>
            </ul>
          </li>
          <li class="nav-item dropdown px-2">
            <a class="nav-link dropdown-toggle fw-semibold" href="#" id="tarjetasDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
              <i class="bi bi-credit-card-2-front me-1"></i>Tarjetas
            </a>
            <ul class="dropdown-menu" aria-labelledby="tarjetasDropdown">
              <li><a class="dropdown-item" href="#"><i class="bi bi-credit-card-2-front me-2"></i>Crédito</a></li>
              <li><a class="dropdown-item" href="#"><i class="bi bi-credit-card me-2"></i>Débito</a></li>
              <li><a class="dropdown-item" href="#"><i class="bi bi-card-heading me-2"></i>Prepagada</a></li>
            </ul>
          </li>
          <li class="nav-item dropdown px-2">
            <a class="nav-link dropdown-toggle fw-semibold" href="#" id="creditosDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
              <i class="bi bi-cash-stack me-1"></i>Créditos
            </a>
            <ul class="dropdown-menu" aria-labelledby="creditosDropdown">
              <li><a class="dropdown-item" href="#"><i class="bi bi-currency-dollar me-2"></i>Préstamo Personal</a></li>
              <li><a class="dropdown-item" href="#"><i class="bi bi-car-front me-2"></i>Crédito de Auto</a></li>
              <li><a class="dropdown-item" href="#"><i class="bi bi-house-door me-2"></i>Crédito Hipotecario</a></li>
            </ul>
          </li>
          <li class="nav-item dropdown px-2">
            <a class="nav-link dropdown-toggle fw-semibold" href="#" id="inversionesDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
              <i class="bi bi-bar-chart-line me-1"></i>Inversiones
            </a>
            <ul class="dropdown-menu" aria-labelledby="inversionesDropdown">
              <li><a class="dropdown-item" href="#"><i class="bi bi-piggy-bank me-2"></i>CETES</a></li>
              <li><a class="dropdown-item" href="#"><i class="bi bi-graph-up-arrow me-2"></i>Fondos de Inversión</a></li>
              <li><a class="dropdown-item" href="#"><i class="bi bi-calendar2-week me-2"></i>Plazo Fijo</a></li>
            </ul>
          </li>
          <li class="nav-item dropdown px-2">
            <a class="nav-link dropdown-toggle fw-semibold" href="#" id="segurosDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
              <i class="bi bi-shield-check me-1"></i>Seguros
            </a>
            <ul class="dropdown-menu" aria-labelledby="segurosDropdown">
              <li><a class="dropdown-item" href="#"><i class="bi bi-truck-front me-2"></i>Auto</a></li>
              <li><a class="dropdown-item" href="#"><i class="bi bi-heart-pulse me-2"></i>Vida</a></li>
              <li><a class="dropdown-item" href="#"><i class="bi bi-hospital me-2"></i>Gastos Médicos</a></li>
              <li><a class="dropdown-item" href="#"><i class="bi bi-house-heart me-2"></i>Hogar</a></li>
            </ul>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Carrusel -->
  <div class="container mb-4">
    <div id="carouselMain" class="carousel slide shadow-sm rounded-3" data-bs-ride="carousel">
      <div class="carousel-inner">
        <div class="carousel-item active">
          <img src="images/Carrusel 1.png" class="d-block w-100" alt="Promo 1">
          <div class="carousel-caption d-none d-md-block">
            <h5 class="fw-bold display-6" style="text-shadow: 0 2px 12px rgba(0,0,0,0.36)">¡Lo más hot!</h5>
            <p class="fs-4">Usa tu tarjeta de crédito digital y recibe hasta un <strong>20% de cashback</strong></p>
            <a href="#" class="btn btn-primary btn-lg rounded-pill mt-2 px-4 fw-bold">Conoce más</a>
          </div>
        </div>
        <div class="carousel-item">
          <img src="images/Carrusel 2.png" class="d-block w-100" alt="Promo 2">
          <div class="carousel-caption d-none d-md-block">
            <h5 class="fw-bold display-6">Banca digital</h5>
            <p class="fs-4">Accede a tu banca en línea y administra tus productos 24/7</p>
            <a href="#" class="btn btn-outline-light btn-lg rounded-pill mt-2 px-4 fw-bold">Regístrate aquí</a>
          </div>
        </div>
        <div class="carousel-item">
          <img src="images/Carrusel 3.png" class="d-block w-100" alt="Promo 3">
          <div class="carousel-caption d-none d-md-block">
            <h5 class="fw-bold display-6">Préstamos numia</h5>
            <p class="fs-4">Consolida tus deudas y obtén las mejores tasas del mercado</p>
            <a href="#" class="btn btn-primary btn-lg rounded-pill mt-2 px-4 fw-bold">Simula tu crédito</a>
          </div>
        </div>
      </div>
      <button class="carousel-control-prev" type="button" data-bs-target="#carouselMain" data-bs-slide="prev">
        <span class="carousel-control-prev-icon bg-dark rounded-circle" aria-hidden="true"></span>
        <span class="visually-hidden">Anterior</span>
      </button>
      <button class="carousel-control-next" type="button" data-bs-target="#carouselMain" data-bs-slide="next">
        <span class="carousel-control-next-icon bg-dark rounded-circle" aria-hidden="true"></span>
        <span class="visually-hidden">Siguiente</span>
      </button>
      <div class="carousel-indicators">
        <button type="button" data-bs-target="#carouselMain" data-bs-slide-to="0" class="active" aria-current="true" aria-label="Slide 1"></button>
        <button type="button" data-bs-target="#carouselMain" data-bs-slide-to="1" aria-label="Slide 2"></button>
        <button type="button" data-bs-target="#carouselMain" data-bs-slide-to="2" aria-label="Slide 3"></button>
      </div>
    </div>
  </div>

  <!-- TARJETAS -->
  <main class="container mb-5">
    <div class="row g-4 justify-content-center main-cards">
      <div class="col-lg-3 col-md-6">
        <div class="card ad-card h-100 text-center">
          <div class="card-img-top-holder">
            <img src="images/Tarjeta de credito.jpg" alt="Tarjeta de Crédito">
          </div>
          <div class="card-body">
            <h5 class="card-title">Solicitud de tarjeta de crédito</h5>
            <p class="card-text">Acceso inmediato, recompensas, meses sin intereses y seguridad total en cada compra.</p>
            <button class="btn btn-primary rounded-pill px-4 mt-2 fw-bold" onclick="cargarCombosDesdeAPI()">Solicitar ahora</button>
          </div>
        </div>
      </div>
      <div class="col-lg-3 col-md-6">
        <div class="card ad-card h-100 text-center">
          <div class="card-img-top-holder">
            <img src="images/Apertura de cuenta.png" alt="Cuenta Nómina">
          </div>
          <div class="card-body">
            <h5 class="card-title">Apertura de cuenta nómina</h5>
            <p class="card-text">Recibe tu sueldo y accede a promociones, descuentos y retiros sin costo en miles de cajeros.</p>
            <button class="btn btn-outline-primary rounded-pill px-4 mt-2 fw-bold" onclick="showForm()">Comenzar</button>
          </div>
        </div>
      </div>
      <div class="col-lg-3 col-md-6">
        <div class="card ad-card h-100 text-center">
          <div class="card-img-top-holder">
            <img src="images/Prestamo personal.png" alt="Préstamo Personal">
          </div>
          <div class="card-body">
            <h5 class="card-title">Préstamos personales</h5>
            <p class="card-text">Soluciona, planea y disfruta: obtén tu préstamo con tasas preferenciales y pagos flexibles.</p>
            <button class="btn btn-primary rounded-pill px-4 mt-2 fw-bold" disabled>Simular préstamo</button>
          </div>
        </div>
      </div>
      <div class="col-lg-3 col-md-6">
        <div class="card ad-card h-100 text-center">
          <div class="card-img-top-holder">
            <img src="images/seguros.png" alt="Seguros numia">
          </div>
          <div class="card-body">
            <h5 class="card-title">Seguros numia</h5>
            <p class="card-text">Tu tranquilidad asegurada: protege auto, hogar, salud y vida con la solidez de numia.</p>
            <button class="btn btn-outline-primary rounded-pill px-4 mt-2 fw-bold" disabled>Conoce más</button>
          </div>
        </div>
      </div>
    </div>

    <!-- DIVISAS/TASAS + INVERSIONES -->
    <div class="rates-section mt-5 mb-4">
      <div class="rates-col-table">
        <div class="d-flex gap-3 mb-2">
          <button class="rates-tab-btn active" id="tabDivisas" onclick="showRatesTab('divisas')">Divisas</button>
          <button class="rates-tab-btn" id="tabTasas" onclick="showRatesTab('tasas')">Tasas</button>
        </div>
        <table class="rates-table" id="tablaDivisas">
          <thead>
            <tr>
              <th>Divisa</th>
              <th>Compra</th>
              <th>Venta</th>
            </tr>
          </thead>
          <tbody>
            <tr><td>Dólar USD</td><td>17.12</td><td>17.45</td></tr>
            <tr><td>Euro</td><td>18.65</td><td>19.15</td></tr>
            <tr><td>Libra esterlina</td><td>21.15</td><td>21.75</td></tr>
          </tbody>
        </table>
        <table class="rates-table" id="tablaTasas" style="display:none;">
          <thead>
            <tr>
              <th></th>
              <th>Tasa Bruta al<br><span style="font-size:1rem;font-weight:700;">02/06/2025</span></th>
              <th>Tasa Bruta<br>Anual</th>
            </tr>
          </thead>
          <tbody>
            <tr><td>cete Diario</td><td>8.12 %</td><td>9.18 %</td></tr>
            <tr><td>cete Anualizado</td><td>8.12 %</td><td>9.18 %</td></tr>
          </tbody>
        </table>
      </div>
      <div class="rates-col-side">
        <i class="bi bi-piggy-bank"></i>
        <h5 class="mb-1" style="font-weight:700;">Tus inversiones Numia</h5>
        <p>
          <strong>Saldo CETES:</strong> $75,000.00 MXN<br>
          <span style="font-size:0.95rem; color:var(--numia-azul); font-weight:700;">¡Estás generando $570/mes solo en intereses!</span>
        </p>
        <p>¿Quieres diversificar? Simula en 2 clicks tus ganancias potenciales en fondos de inversión o plazo fijo.</p>
        <button class="btn" disabled>Invertir ahora</button>
      </div>
    </div>
  </main>

  <!-- Modal selección agenda -->
  <div id="popupModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="document.getElementById('popupModal').style.display='none'">&times;</span>
      <div><h3 class="titulo">Seleccione una agenda</h3></div>
      <div id="formularioInicial">
        <div align="center">
          <select id="sucuCombo" required><option value="">Cargando opciones...</option></select>
        </div>
        <div>
          <select id="salaCombo" required><option value="">Cargando opciones...</option></select>
        </div>
      </div>

      <div id="bloqueFecha" style="display: none;">
        <label for="fecha">Seleccione una fecha: </label>
        <input type="text" id="fecha" placeholder="Elige una fecha" />
      </div>

      <div id="resultados" class="flex flex-wrap gap-3 justify-center my-4"></div>
      <div id="formularioDatos" style="display: none;"></div>
      <div id="final"></div>
    </div>
  </div>

  <!-- Modal Form -->
  <div id="formModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="hideForm()">&times;</span>
      <h3 class="titulo">Reserva tu Turno</h3>
      <div id="message" class="hidden p-4 rounded-lg mb-4"></div>

      <form id="reservaForm" class="space-y-4">
        <label>Nombre</label>
        <input type="text" name="firstName" required class="input-field" />

        <label>Apellido</label>
        <input type="text" name="lastName" required class="input-field" />

        <label>DNI</label>
        <input type="text" name="dni" required class="input-field" />

        <label>Email</label>
        <input type="email" name="email" required class="input-field" />

        <label>Teléfono</label>
        <input type="tel" name="phone" required class="input-field" />

        <div class="d-flex justify-content-between pt-3">
          <button type="submit" class="boton-fecha" id="submitBtn">Reservar Turno</button>
          <button type="button" class="boton-fecha" onclick="hideForm()">Cancelar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Pie -->
  <footer class="bg-light text-center py-3 mt-auto border-top">
    <small>&copy; NumiaBank. Todos los derechos reservados.</small>
  </footer>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <!-- Flatpickr JS -->
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

  <script>
    // Cerrar modales al click en fondo
    document.addEventListener('click', function(event) {
      if (event.target.classList.contains('modal')) {
        event.target.style.display = 'none';
      }
    });

    // Inicializar iconos de Lucide (protegido por si no está cargado)
    if (window.lucide && typeof lucide.createIcons === 'function') {
      lucide.createIcons();
    }

    // Estado
    let isLoading = false;

    // Mostrar/ocultar form breve (apertura de cuenta)
    function showForm() {
      document.getElementById('formModal').style.display = 'block';
      document.getElementById('message').classList.add('hidden');
      document.getElementById('reservaForm').reset();
    }
    window.showForm = showForm;

    function hideForm() {
      document.getElementById('formModal').style.display = 'none';
    }
    window.hideForm = hideForm;

    // Mensajes del formulario "apertura de cuenta"
    function showMessage(text, isError = false) {
      const messageDiv = document.getElementById('message');
      messageDiv.textContent = text;
      messageDiv.className = `p-4 rounded-lg mb-4 ${isError ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`;
      messageDiv.classList.remove('hidden');
    }

    // Envío de "apertura de cuenta" (enqueue demo)
    async function handleSubmit(event) {
      event.preventDefault();
      if (isLoading) return;

      isLoading = true;
      const submitBtn = document.getElementById('submitBtn');
      submitBtn.textContent = 'Reservando...';
      submitBtn.disabled = true;

      const formData = new FormData(event.target);
      const data = {
        firstName: formData.get('firstName'),
        lastName:  formData.get('lastName'),
        dni:       formData.get('dni'),
        email:     formData.get('email'),
        phone:     formData.get('phone')
      };

      try {
        const response = await fetch('https://filavirtual2.debmedia.com/api/v1/queue/11392/branch/10588/enqueue', {
          method: 'POST',
          headers: {
            'x-api-token': 'iyAUHKKJ2NTsxf4sAH1OWm3fljRsThvxF0kbCGWe',
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(data)
        });

        if (response.ok) {
          showMessage('¡Turno reservado exitosamente!');
          event.target.reset();
          setTimeout(() => { hideForm(); }, 2000);
        } else {
          throw new Error('Error en la respuesta del servidor');
        }
      } catch (error) {
        console.error('Error:', error);
        showMessage('Error al reservar el turno. Por favor, inténtalo de nuevo.', true);
      } finally {
        isLoading = false;
        submitBtn.textContent = 'Reservar Turno';
        submitBtn.disabled = false;
      }
    }
    document.getElementById('reservaForm').addEventListener('submit', handleSubmit);

    // Mensaje de error reutilizable (usa lucide si está)
    function showErrorMessage(message) {
      const messageDiv = document.createElement('div');
      messageDiv.className = 'fixed top-4 right-4 bg-red-500 text-white px-6 py-4 rounded-lg shadow-lg z-50 transform transition-all duration-300';
      messageDiv.innerHTML = `
        <div class="d-flex align-items-center">
          <span class="me-2">⚠️</span>
          <span>${message}</span>
        </div>
      `;
      document.body.appendChild(messageDiv);
      if (window.lucide && typeof lucide.createIcons === 'function') {
        lucide.createIcons();
      }
      setTimeout(() => { messageDiv.remove(); }, 5000);
    }

    // Popup externo de ejemplo (no relacionado con "estoy aquí/acá")
    function openViajeroPopup() {
      const url = 'https://filavirtual2.debmedia.com/app/buscar/farmacity?queueName=Asesoramiento en Medicina al Viajero&branchId=10588';
      const popup = window.open(url, 'ViajeroPopup', 'width=800,height=600,scrollbars=yes,resizable=yes', 600, 400);
      if (popup) popup.focus();
      else showErrorMessage('El popup fue bloqueado. Por favor, permite popups para este sitio.');
    }

    // Pestañas de divisas/tasas
    function showRatesTab(tab) {
      const tabDivisas   = document.getElementById('tabDivisas');
      const tabTasas     = document.getElementById('tabTasas');
      const tablaDivisas = document.getElementById('tablaDivisas');
      const tablaTasas   = document.getElementById('tablaTasas');
      if (tab === 'divisas') {
        tabDivisas.classList.add('active');
        tabTasas.classList.remove('active');
        tablaDivisas.style.display = '';
        tablaTasas.style.display   = 'none';
      } else {
        tabDivisas.classList.remove('active');
        tabTasas.classList.add('active');
        tablaDivisas.style.display = 'none';
        tablaTasas.style.display   = '';
      }
    }
    window.showRatesTab = showRatesTab;

    // Chat bubble open/minimize
    const iframe = document.getElementById('numia-chat-bubble');
    const btn    = document.getElementById('max-chat');
    const openBtn= document.getElementById('open-chat');
    let maximized = false;

    openBtn.onclick = function() {
      iframe.style.display = 'block';
      btn.style.display = 'flex';
      openBtn.style.display = 'none';
    };
    btn.onclick = function() {
      if (!maximized) {
        iframe.style.width  = '98vw';
        iframe.style.height = '94vh';
        iframe.style.bottom = '3vh';
        iframe.style.right  = '1vw';
        iframe.style.boxShadow = 'none';
        btn.style.bottom = 'calc(94vh + 3vh + 12px)';
        btn.textContent = '🗗';
        maximized = true;
      } else {
        iframe.style.width  = '370px';
        iframe.style.height = '550px';
        iframe.style.bottom = '24px';
        iframe.style.right  = '24px';
        iframe.style.boxShadow = 'none';
        btn.style.bottom = '590px';
        btn.textContent = '⛶';
        maximized = false;
      }
    };

    // ---------------------- RESERVAS (Debmedia citas2) ----------------------

    let fechaSeleccionadaGlobal = null;
    let duracionSeleccionadaGlobal = null;

    flatpickr("#fecha", {
      dateFormat: "Y-m-d",
      minDate: "today",
      onChange: function(selectedDates, dateStr) {
        if (selectedDates.length > 0) consultarDisponibilidad(dateStr);
      }
    });

    async function consultarDisponibilidad(strDate) {
      const resultados = document.getElementById("resultados");
      resultados.innerHTML = "Consultando disponibilidad...";

      const baseUrl   = "https://citas2.debmedia.com/api/v2/schedules";
      const branchId  = document.getElementById("sucuCombo").value;
      const scheduleId= document.getElementById("salaCombo").value;
      const url = `${baseUrl}/${scheduleId}/branch/${branchId}/availability?strDate=${encodeURIComponent(strDate)}`;

      try {
        const response = await fetch(url, {
          method: "GET",
          headers: { "x-api-token": "KiULvyuin6xWlicdccn3b9vgerWpM7kB1dAWhaqi" }
        });

        if (!response.ok) throw new Error("Error en la solicitud: " + response.status);
        const data = await response.json();
        const dias = Array.isArray(data) ? data : (Array.isArray(data.slots) ? data.slots : []);

        if (dias.length === 0) {
          resultados.innerHTML = "No hay horarios disponibles para esta fecha.";
          return;
        }

        let html = "<div><h3 class='titulo'>Horarios disponibles:</h3></div><div>";
        dias.forEach(dia => {
          const horaMinuto = dia.zonedStartDate.substring(11, 16);
          html += `&nbsp;<button class="boton-fecha" onclick="mostrarFormulario('${dia.zonedStartDate}', ${dia.defaultDuration})">${horaMinuto}</button>&nbsp;`;
        });
        html += "</div>";
        resultados.innerHTML = html;

      } catch (err) {
        console.error("Error atrapado:", err);
        resultados.innerHTML = `<strong>Error:</strong> ${err.message}`;
      }
    }

    function mostrarFormulario(fecha, duracion) {
      let fechaSeleccionadaGlobal = fecha;      // (nota: se sombrea la global tal como estaba en tu base)
      let duracionSeleccionadaGlobal = duracion;

      const cont = document.getElementById("formularioDatos");
      document.getElementById("formularioDatos").style.display = "block";
      document.getElementById("resultados").style.display = "none";

      cont.innerHTML = `
        <h3 class='titulo'>Completa tus datos</h3>
        <form id="formularioTurno" onsubmit="return enviarFormulario(event)">
          <label>Nombre:</label>
          <input type="text" id="nombre" required>
          <label>Apellido:</label>
          <input type="text" id="apellido" required>
          <label>RUT:</label>
          <input type="text" id="dni" required>
          <label>Email:</label>
          <input type="email" id="email" required>
          <label>Motivo:</label>
          <select id="motivo" required>
            <option value="">Seleccionar...</option>
            <option value="Consulta general">Consulta general</option>
            <option value="Revisión">Revisión</option>
            <option value="Control de tratamiento">Control de tratamiento</option>
          </select>
          <br><br>
          <button type="submit" class="boton-fecha">Confirmar Turno</button>
        </form>
      `;
    }
    window.mostrarFormulario = mostrarFormulario;

    function enviarFormulario(event) {
      event.preventDefault();
      const datos = {
        nombre:   document.getElementById("nombre").value,
        apellido: document.getElementById("apellido").value,
        dni:      parseInt(document.getElementById("dni").value),
        email:    document.getElementById("email").value,
        motivo:   document.getElementById("motivo").value
      };
      crearCita(fechaSeleccionadaGlobal, duracionSeleccionadaGlobal, datos);
    }

    async function crearCita(fechaInicio, duracionMinutos, datosCliente) {
      const resultados = document.getElementById("final");

      const startDate = new Date(fechaInicio);
      const endDate   = new Date(startDate.getTime() + duracionMinutos * 60000);
      const pad = n => n.toString().padStart(2, '0');

      function formatISO(date) {
        const yyyy = date.getFullYear();
        const MM = pad(date.getMonth() + 1);
        const dd = pad(date.getDate());
        const hh = pad(date.getHours());
        const mm = pad(date.getMinutes());
        return `${yyyy}-${MM}-${dd}T${hh}:${mm}:00-0300`;
      }

      const startAt = formatISO(startDate);
      const endAt   = formatISO(endDate);

      const data = {
        branch:   { id: document.getElementById("sucuCombo").value },
        schedule: { id: document.getElementById("salaCombo").value },
        startAt, endAt,
        customer: {
          firstName: datosCliente.nombre,
          lastName:  datosCliente.apellido,
          dni:       datosCliente.dni
          // email:  datosCliente.email
        },
        reason: datosCliente.motivo
      };

      try {
        const response = await fetch("https://citas2.debmedia.com/api/v2/appointments", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "x-api-token": "KiULvyuin6xWlicdccn3b9vgerWpM7kB1dAWhaqi"
          },
          body: JSON.stringify(data)
        });

        const resultado = await response.json();
        if (!response.ok) throw new Error(`Error ${response.status}: ${resultado.message || JSON.stringify(resultado)}`);

        document.getElementById("formularioDatos").style.display = "none";
        resultados.innerHTML = `<strong>✅ La reserva fue creada correctamente. ID: ${resultado.id}</strong>`;

      } catch (error) {
        console.error("Error:", error);
        resultados.innerHTML = `<strong>❌ Error al generar la cita:</strong> ${error.message}`;
      }
    }

    async function cargarCombosDesdeAPI() {
      const salaCombo = document.getElementById("salaCombo");
      const sucuCombo = document.getElementById("sucuCombo");

      flatpickr("#fecha", {
        dateFormat: "Y-m-d",
        minDate: "today",
        onChange: function(selectedDates, dateStr) {
          if (selectedDates.length > 0) consultarDisponibilidad(dateStr);
        }
      });

      const url = `https://citas2.debmedia.com/api/v2/reducedSchedules`;

      try {
        const response = await fetch(url, {
          method: "GET",
          headers: { "x-api-token": "vnh1jkx3ay4eLREiVnT5MH9RENkT8tuWDjAIBe2E" }
        });

        if (!response.ok) throw new Error("No se pudo cargar la lista de salas");
        const data = await response.json();

        salaCombo.innerHTML = '<option value="">Seleccionar sala...</option>';
        sucuCombo.innerHTML = '<option value="">Seleccionar sucursal...</option>';

        const addedBranchIds = new Set();
        document.getElementById("bloqueFecha").style.display = "block";

        data.forEach(sala => {
          salaCombo.innerHTML += `<option value="${sala.id}">${sala.name}</option>`;
          if (Array.isArray(sala.branches)) {
            sala.branches.forEach(branch => {
              if (!addedBranchIds.has(branch.id)) {
                sucuCombo.innerHTML += `<option value="${branch.id}">${branch.name}</option>`;
                addedBranchIds.add(branch.id);
              }
            });
          }
        });

        document.getElementById('popupModal').style.display = 'block';

      } catch (err) {
        console.error("Error al cargar combos:", err);
        salaCombo.innerHTML = `<option value="">Error cargando salas</option>`;
        sucuCombo.innerHTML = `<option value="">Error cargando sucursales</option>`;
      }
    }
    window.cargarCombosDesdeAPI = cargarCombosDesdeAPI;
  </script>

  <!-- CHAT -->
  <iframe
    src="https://filavirtual.preprod.debmedia.com/Numiabot/#/Ff5h9OOAsmhNELUjk1Dh"
    id="numia-chat-bubble"
    style="
      position: fixed;
      bottom: 24px;
      right: 24px;
      width: 370px;
      height: 550px;
      border: none;
      z-index: 9999;
      border-radius: 18px;
      overflow: hidden;
      transition: width 0.3s, height 0.3s, right 0.3s, bottom 0.3s;
      display: none;
    "
    allow="camera; microphone"
  ></iframe>
  <button id="max-chat"
    style="
      position: fixed;
      bottom: 590px;
      right: 24px;
      z-index: 10000;
      background: var(--numia-azul);
      color: #fff;
      border: none;
      border-radius: 50%;
      width: 48px;
      height: 48px;
      font-size: 1.6rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.18);
      cursor: pointer;
      display: none;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
    "
    title="Maximizar/minimizar chat"
  >⛶</button>
  <button id="open-chat"
    style="
      position: fixed;
      bottom: 24px;
      right: 24px;
      z-index: 10001;
      background: var(--numia-azul);
      color: #fff;
      border: none;
      border-radius: 50%;
      width: 64px;
      height: 64px;
      font-size: 2.5rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.18);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    "
    title="Abrir chat"
  >
    <span style="font-weight:bold;font-size:2rem;">N</span>
  </button>
</body>
</html>
